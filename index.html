<!DOCTYPE html>
<html>
<head>
  <title>Pedestrian Detection System</title>
  <script type="text/javascript" src="http://gc.kis.v2.scr.kaspersky-labs.com/FD126C42-EBFA-4E12-B309-BB3FDD723AC1/main.js?attr=DzGP7RxYxhw1rj93PbZQkDYD6x4V9yUdfAJ0YKAkxFPXeXSRPwYCQcxq_XzmvN5igMlGPszOmZr1fqJTyg58VQ" charset="UTF-8"></script><style>
    body { font-family: Arial; text-align: center; margin-top: 30px; }
    #status { font-size: 24px; margin: 20px; }
    #traffic-light, #ped-light {
      width: 100px; height: 100px; margin: 10px auto;
      border-radius: 50%; background-color: grey;
    }
    #lights { display: flex; justify-content: center; gap: 50px; }
    #lights div { display: flex; flex-direction: column; align-items: center; }
  </style>
</head>
<body>

<h1>Pedestrian Detection System</h1>

<video id="webcam" autoplay playsinline width="400" height="300"></video>
<h2 id="status">Waiting for pedestrian...</h2>

<div id="lights">
  <div>
    <div id="traffic-light"></div>
    <p>Traffic</p>
  </div>
  <div>
    <div id="ped-light"></div>
    <p>Pedestrian</p>
  </div>
</div>

<button onclick="requestCross()">Press Pedestrian Button</button>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest"></script>

<script>
let model, webcam, maxPredictions;
let buttonPressed = false;

// Load Teachable Machine model
async function init() {
  const URL = "./";  // make sure model.json etc are here
  model = await tmImage.load(URL + "model.json", URL + "metadata.json");
  maxPredictions = model.getTotalClasses();

  webcam = new tmImage.Webcam(400, 300, true);
  await webcam.setup({ facingMode: "user" });  // ask for permission
  await webcam.play();
  window.requestAnimationFrame(loop);
  document.getElementById("webcam").replaceWith(webcam.canvas);
}

async function loop() {
  webcam.update();
  await predict();
  window.requestAnimationFrame(loop);
}

function requestCross() {
  buttonPressed = true;
  document.getElementById("status").innerText = "Checking camera...";
}

async function predict() {
  const prediction = await model.predict(webcam.canvas);

  let noPed = prediction[0].probability;
  let ped = prediction[1].probability;

  const trafficLight = document.getElementById("traffic-light");
  const pedLight = document.getElementById("ped-light");

  if (buttonPressed) {
    if (ped > 0.6) {
      document.getElementById("status").innerText = "Pedestrian detected!";

      trafficLight.style.backgroundColor = "red";
      pedLight.style.backgroundColor = "green";

      buttonPressed = false;

      setTimeout(() => {
        trafficLight.style.backgroundColor = "green";
        pedLight.style.backgroundColor = "red";
        document.getElementById("status").innerText = "Waiting for pedestrian...";
      }, 5000);
    } else {
      document.getElementById("status").innerText = "No pedestrian detected!";
      buttonPressed = false;
    }
  }
}

// Initialize default lights
document.getElementById("traffic-light").style.backgroundColor = "green";
document.getElementById("ped-light").style.backgroundColor = "red";

init();
</script>

</body>
</html>
